
function abuchatbot() {

// ÃœberprÃ¼fen, ob jQuery bereits geladen ist
if (typeof jQuery === 'undefined') {
    var sc = document.createElement("script");
    sc.setAttribute("src", 'https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js');
    sc.setAttribute("type", "text/javascript");
    document.head.appendChild(sc);
}

/** Warten bis alle Javascript-Bibliotheken geladen sind. */
var bln_mCustomScrollbarLoaded = false;
var blnJSLoaded = false;
var iJSLoad = setInterval(function() {
    if(typeof jQuery !== 'undefined') {
        if(typeof $ === 'undefined') $ = jQuery;
        
        if(bln_mCustomScrollbarLoaded == false) {
            bln_mCustomScrollbarLoaded = true;
            var mCustomScrollbarScript = document.createElement('script');
            mCustomScrollbarScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.concat.min.js';
            document.head.appendChild(mCustomScrollbarScript);            
        }
        if(typeof $.mCustomScrollbar !== 'undefined') {
            clearInterval(iJSLoad);
            blnJSLoaded = true;
        }
            
    }
}, 100);

var blnCSSLoaded = false;
var iCSSLoad = setInterval(function() {
    var bodyStyles = window.getComputedStyle(document.body);
    var fooBar = bodyStyles.getPropertyValue('--abuchatloaded');
    
    if(fooBar) {
        clearInterval(iCSSLoad);
        blnCSSLoaded = true;
    }
}, 200);

/** CSS Laden */
/** Google Font */
var sc = document.createElement("link");
sc.setAttribute("href", 'https://fonts.googleapis.com/css?family=Open+Sans');
sc.setAttribute("type", "text/css");
sc.setAttribute("rel", "stylesheet");
document.head.appendChild(sc);

/** mCustomScrollbar */
sc = document.createElement("link");
sc.setAttribute("href", 'https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.min.css');
sc.setAttribute("type", "text/css");
sc.setAttribute("rel", "stylesheet");
document.head.appendChild(sc);

/** aBusiness Styles */
sc = document.createElement("link");
sc.setAttribute("href", "https://files.abusiness.net/chatbot/v1/style.css?v=11");
sc.setAttribute("type", "text/css");
sc.setAttribute("rel", "stylesheet");
document.head.appendChild(sc);



/** aBusiness Chat-UUID */
var chatbotuuid = "ced520ce-76b1-11ee-9dda-42010a72c006";

/** Ein paar Funktionen laden: */
function btoaEx(str) {
    // first we use encodeURIComponent to get percent-encoded UTF-8,
    // then we convert the percent encodings into raw bytes which
    // can be fed into btoa.
    return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
        function toSolidBytes(match, p1) {
            return String.fromCharCode('0x' + p1);
    }));
}
function atobEx(str) {
    // Going backwards: from bytestream, to percent-encoding, to original string.
    return decodeURIComponent(atob(str).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
}
function guid() {
  function s4() {
    return Math.floor((1 + Math.random()) * 0x10000)
      .toString(16)
      .substring(1);
  }
  return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
    s4() + '-' + s4() + s4() + s4();
}
/*
function getCookie(k){var v=document.cookie.match('(^|;) ?'+k+'=([^;]*)(;|$)');return v?v[2]:null}
function createCookie(name, value, days) {
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        var expires = "; expires=" + date.toUTCString();
    } else {
        var expires = "";
    }
    document.cookie = name + "=" + value + expires + "; path=/";
}
function setCookie(c_name, value, exdays) {
    var exdate = new Date();
    exdate.setDate(exdate.getDate() + exdays);
    var c_value = escape(value) + ((exdays == null) ? "" : "; expires=" + exdate.toUTCString()) + "; path=/";
    document.cookie = c_name + "=" + c_value;
}*/
function setCookie(c_name, value, exdays) {
    var existingCookie = getCookie(c_name);
    if (existingCookie !== null) {
        deleteCookie(c_name);
    }
    var exdate = new Date();
    exdate.setDate(exdate.getDate() + exdays);
    var c_value = escape(value) + ((exdays == null) ? "" : "; expires=" + exdate.toUTCString()) + "; path=/";
    document.cookie = c_name + "=" + c_value;
}

function getCookie(c_name) {
    var name = c_name + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var cookies = decodedCookie.split(';');
    for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i];
        while (cookie.charAt(0) == ' ') {
            cookie = cookie.substring(1);
        }
        if (cookie.indexOf(name) == 0) {
            return cookie.substring(name.length, cookie.length);
        }
    }
    return null;
}

function deleteCookie(c_name) {
    document.cookie = c_name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/";
}


function trim (str, charlist) {
  var whitespace = [
    ' ',
    '\n',
    '\r',
    '\t',
    '\f',
    '\x0b',
    '\xa0',
    '\u2000',
    '\u2001',
    '\u2002',
    '\u2003',
    '\u2004',
    '\u2005',
    '\u2006',
    '\u2007',
    '\u2008',
    '\u2009',
    '\u200a',
    '\u200b',
    '\u2028',
    '\u2029',
    '\u3000'
  ].join('')
  var l = 0
  var i = 0
  str += ''

  if (charlist) {
    whitespace = (charlist + '').replace(/([\[\]\(\)\.\?\/\*\{\}\+\$\^:])/g, '$1')
  }

  l = str.length
  for (i = 0; i < l; i++) {
    if (whitespace.indexOf(str.charAt(i)) === -1) {
      str = str.substring(i)
      break
    }
  }

  l = str.length
  for (i = l - 1; i >= 0; i--) {
    if (whitespace.indexOf(str.charAt(i)) === -1) {
      str = str.substring(0, i + 1)
      break
    }
  }

  return whitespace.indexOf(str.charAt(0)) === -1 ? str : ''
}

/** Senden eine Chat-Nachricht an die API und liefert das
    Resultat in der Callback Funktion.
 */
function sendChatRequest(chatbotuuid, sessionguid, text, callback) {
  var encodedText = btoaEx(text);
  
  /** JSONP Request */
  $.ajax({
      url: "https://langmeier.abusiness.net/api/v1/gpt/write",
     
      // The name of the callback parameter
      jsonp: "callback",
     
      // Tell jQuery we're expecting JSONP
      dataType: "jsonp",
     
      // Data to be sent
      data: {
        chatbotuuid: chatbotuuid,
        sessionguid: sessionguid,
        text: encodedText,
        lang: 'de'
              },
     
      // Work with the response
      success: function(response) {                
        if (response == "ERR_LOOKS_LIKE_DDOS") {
          response = "Please try again later.";
        } else {
          response = atobEx(response);
        }
        
        // Verarbeite die Antwort hier
        
        // HTML-Escapen
        function htmlEntities(str) {
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        response = htmlEntities(response);
        
        // Links anklickbar machen
        //response = response.replace(/\b((?:https?|ftp|mailto):\/\/[^\s/$.?#].[^\s]*)\b|\b((?:(?:[a-z]+\.)+[a-z]{2,})\/?[^\s]*)\b|([A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,})\b/g, function(match, urlWithProtocol, urlWithoutProtocol, email) {
        // ula, 29.06.2023: die Zeichen ] und ) sind Stopp-Kriterien fÃ¼r die URL!
        // ula, 02.07.2023: auch Domains mit Bindestrichen und Umlauten unterstÃ¼tzen:
        response = response.replace(/\b((?:https?|ftp|mailto):\/\/[^\s/$.?#].[^\s\]\)]*)\b|\b((?:(?:[a-zA-Z0-9Ã¤Ã¶Ã¼ÃŸÃ„Ã–Ãœ-]+\.)+[a-z]{2,})\/?[^\s\]\)]*)\b|([A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,})\b/g, function(match, urlWithProtocol, urlWithoutProtocol, email) {
                    var url;
                    var urlRef;
                    
                    if (urlWithProtocol) {
                        url = urlWithProtocol;
                        urlRef = urlWithProtocol;
                    } else if (urlWithoutProtocol) {
                        url = urlWithoutProtocol;
                        urlRef = "http://" + urlWithoutProtocol;
                        
                    } else {
                        url = email;
                        urlRef = 'mailto:' + email;
                    }
                    
                    //debug:
                    //console.log( '<a href="' + urlRef + '" target="_blank">' + match + '</a>');
                    
                    return '<a href="' + urlRef + '" target="_blank">' + match + '</a>';
                });
        
        // ZeilenumbrÃ¼che in den Text einfÃ¼gen (Newline to HTML)
        function nl2br (str, is_xhtml) {
            var breakTag = (is_xhtml || typeof is_xhtml === 'undefined') ? '<br />' : '<br>';
            return (str + '').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1' + breakTag + '$2');
        }
        response = nl2br(response);
        
        // Ãœbergebene Callback Funktion ausfÃ¼hren.
        callback(response);
      }
      
      ,error: function(xhr, status, error) {
          // Retry after timeout
          setTimeout(function() {
            sendChatRequest(chatbotuuid, sessionguid, text, callback);
          }, 3000);
      }
  });
}

function checkChatFieldSize() {
    /** PrÃ¼fen ob das Textfeld vergrÃ¶ssert werden soll. */
    let sh = $(".abusiness-chatbot-message-input")[0].scrollHeight;
    let mh = $(".abusiness-chatbot-message-input").height();
    if(sh != mh || mh > 25) {
        $(".abusiness-chatbot-message-input").height("25px");
        $(".abusiness-chatbot-message-input").height( $(".abusiness-chatbot-message-input")[0].scrollHeight );
    }
}

function updateScrollbar() {
  $messages.mCustomScrollbar("update").mCustomScrollbar('scrollTo', 'bottom', {
    scrollInertia: 10,
    timeout: 0
  });
}

function leadingZero(minutes) {
  return minutes < 10 ? '0' + minutes : minutes;
}

function setDate(){
  d = new Date()
  if (m != d.getMinutes()) {
    m = leadingZero(d.getMinutes());
    $('<div class="abusiness-chatbot-timestamp">' + d.getHours() + ':' + m + '</div>').appendTo($('.abusiness-chatbot-message:last'));
  }
}

/** Session GUID holen oder erstellen.
    StandardmÃ¤ssig bei jedem Reload eine neue Session erstellen.
*/
var blnParamRefresh = true;
var sessionguid = guid();
if(!getCookie("abuchat_sessionguid") || blnParamRefresh == true) {
    setCookie("abuchat_sessionguid", sessionguid, 1);
} else {
    sessionguid = getCookie("abuchat_sessionguid");
}

var tLoading;
var chatRequestPromise;
var chatRequestPromiseController;
function insertMessage() {
  /** Die TextfeldgrÃ¶sse reseten. */
  $(".abusiness-chatbot-message-input").height("25px");
  
  msg = $('.abusiness-chatbot-message-input').val();
  if ($.trim(msg) == '') {
    return false;
  }
  
  if(tLoading) clearTimeout(tLoading);
  stopIntervallMessage();
  
  if(chatRequestPromise) {
    // Abbrechen der vorherigen AusfÃ¼hrung
    chatRequestPromiseController.abort();
  }
  $('.abusiness-chatbot-message.abusiness-chatbot-loading').remove();
  
  
//  sendChatRequest(chatbotuuid, sessionguid, msg, function(result) {
//    if(tLoading) clearTimeout(tLoading);
//    displayMessageSplit(result);
//  });
  
  /** API Befehl abgeben */
  // Funktion, die den Chat anfordert und ein Promise zurÃ¼ckgibt
  function sendChatRequestPromise(chatbotuuid, sessionguid, msg) {
      return new Promise((resolve, reject) => {
        chatRequestPromiseController = new AbortController();
        const signal = chatRequestPromiseController.signal;
        var blnReject = false;
        
        signal.addEventListener('abort', () => {
          blnReject = true;
        });
        
        // Chat-Anfrage senden
        sendChatRequest(chatbotuuid, sessionguid, msg, function(result) {
          if(tLoading) clearTimeout(tLoading); // Timeout lÃ¶schen, da die Anfrage erfolgreich war
          if(blnReject == false) {
            displayMessageSplit(result);
          }
          resolve(result);
        });
      });
  }
  
  // Aufruf der Funktion als Promise
  chatRequestPromise = sendChatRequestPromise(chatbotuuid, sessionguid, msg);
  
  
  $('<div class="abusiness-chatbot-message abusiness-chatbot-message-personal">' + msg + '</div>').appendTo($('.mCSB_container')).addClass('abusiness-chatbot-new');
  setDate();
  $('.abusiness-chatbot-message-input').val(null);
  updateScrollbar();
  
  tLoading = setTimeout(function() {
    $('<div class="abusiness-chatbot-message abusiness-chatbot-loading abusiness-chatbot-new"><figure class="abusiness-chatbot-avatar"><img src="https://langmeier.abusiness.net/getfile/cedb2105-76b1-11ee-9dda-42010a72c006?download" /></figure><span></span></div>').appendTo($('.mCSB_container'));
    updateScrollbar();
  }, 1000);
  
}

// Globales Array fÃ¼r die Intervall-IDs
var intervalIDs = [];

// Funktion zum Stoppen aller Intervalle
function stopIntervallMessage() {
    // Durchlaufe alle Intervall-IDs im Array
    for (var i = 0; i < intervalIDs.length; i++) {
        clearInterval(intervalIDs[i]); // Stoppe das aktuelle Intervall
    }
    
    // Leere das Intervall-Array
    intervalIDs = [];
}

/** Zeigt fÃ¼r jeden neuen Satz eine Nachricht an. */
function displayMessageSplit(msg, blnNoDelay) {
    
    
    //console.log(msg);
    
    // ula, 02.07.2023
    // Wir mÃ¼ssen einen BR2NL machen, sonst kann es bei Auflistungen
    // nicht schÃ¶n trennen:
    
    // BR2NL:
    function br2nl (str) {
        var replacedStr = (str + '').replace(/<br\s*\/?>/g, '\n');
        return replacedStr;
    }    
    let result = br2nl(msg);
    
    //console.log(result);
    
    
    // FÃ¼ge den Trenner vor jedem Eintrag ein
    // let result = msg.replace(/(\d+\.\s)|(\.\s)|(:\s)|(!\s)|(\?\s)/g, '<<split>>$1$2$3$4$5');
    result = result.replace(/(\d+\.\s)|(\.\s[A-Z][a-z]{1,})|(\.[\r\n])|(:\s)|(!\s)|(\?\s)|(<br\s*\/>)/g
                                , '<<split>>$1$2$3$4$5$6$7');    
                              
    // Split bei Punkten, Doppelpunkten, Ausrufezeichen und Fragezeichen (.:!?) umdrehen:
    result = result.replaceAll('<<split>>:', ':<<split>>');
    result = result.replaceAll('<<split>>.', '.<<split>>');
    result = result.replaceAll('<<split>>!', '!<<split>>');
    result = result.replaceAll('<<split>>?', '?<<split>>');
    
    //console.log(result);

    // Teile den modifizierten Text in ein Array auf
    let entries = result.split('<<split>>');
    
    
    var blnFirst = true;
    var inkrement = 0;
    entries.forEach(function(value, index) {
        value = trim(value);
        if(!value) return;
        
        if(blnFirst == true) {
            //Erste Nachricht sofort anzeigen
            displayMessage(value);
            
            /** Waiter anzeigen */
            setTimeout(function() {
                if (index === entries.length - 1) {
                    /** Letzes Element */
                } else {
                    //Es kommen noch mehr Nachrichten
                    /** Wait Message anzeigen */
                    $('<div class="abusiness-chatbot-message abusiness-chatbot-loading abusiness-chatbot-new"><figure class="abusiness-chatbot-avatar"><img src="https://langmeier.abusiness.net/getfile/cedb2105-76b1-11ee-9dda-42010a72c006?download" /></figure><span></span></div>').appendTo($('.mCSB_container'));
                    updateScrollbar();
                }
            }, 1000);
        } else {
            if(blnNoDelay) {
                /** Nachricht anzeigen */
                displayMessage(value);
                                
            } else {
                //Delay einfÃ¼gen
                var intervalID = setTimeout(function() {
                    /** Nachricht anzeigen */
                    displayMessage(value);
                    
                    /** Waiter anzeigen */
                    setTimeout(function() {
                        if (index === entries.length - 1) {
                            /** Letzes Element */
                        } else {
                            //Es kommen noch mehr Nachrichten
                            /** Wait Message anzeigen */
                            $('<div class="abusiness-chatbot-message abusiness-chatbot-loading abusiness-chatbot-new"><figure class="abusiness-chatbot-avatar"><img src="https://langmeier.abusiness.net/getfile/cedb2105-76b1-11ee-9dda-42010a72c006?download" /></figure><span></span></div>').appendTo($('.mCSB_container'));
                            updateScrollbar();
                        }
                    }, 1000);                    
                }, (4000 * inkrement) + ((Math.random() * 20) * 100));
                
                intervalIDs.push(intervalID); // FÃ¼ge die Intervall-ID dem globalen Array hinzu
            }
        }
        
        blnFirst = false;
        ++inkrement;
    });
    

}

/** Zeigt eine Nachricht an. */
function displayMessage(msg) {
  //if ($('.abusiness-chatbot-message-input').val() != '') {
  //  return false;
  //}
  
  $('.abusiness-chatbot-message.abusiness-chatbot-loading').remove();
  $('<div class="abusiness-chatbot-message abusiness-chatbot-new"><figure class="abusiness-chatbot-avatar"><img src="https://langmeier.abusiness.net/getfile/cedb2105-76b1-11ee-9dda-42010a72c006?download" /></figure>' + msg + '</div>').appendTo($('.mCSB_container')).addClass('abusiness-chatbot-new');
  setDate();
  updateScrollbar();
  i++;
}

function insertHTMLAndCallback(html, callback) {
  const body = document.getElementsByTagName('body')[0];
  const tempContainer = document.createElement('div');
  tempContainer.innerHTML = html;

  const observer = new MutationObserver(() => {
    observer.disconnect(); // Beobachtung stoppen, sobald Ã„nderungen erkannt wurden

    if (typeof callback === 'function') {
      callback();
    }
  });

  observer.observe(body, { childList: true });

  const elements = tempContainer.childNodes;
  const fragment = document.createDocumentFragment();

  for (let i = 0; i < elements.length; i++) {
    fragment.appendChild(elements[i].cloneNode(true));
  }

  body.appendChild(fragment);
}

window.mobilecheck = function() {
  var check = false;
  (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
  return check;
};


function isIOS() {
    return /iPhone|iPad|iPod/i.test(navigator.userAgent);
}

function calculateVisibleHeight() {
    const docHeight = Math.max(
        document.documentElement.clientHeight,
        window.innerHeight || 0
    );
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    return docHeight - scrollTop;
}

//GrÃ¶ssen-Anpassung wegen Mobile-Tastatur.
var abusiness_chatbot_chat_height; //Hier wird die ursprÃ¼ngliche Original-GrÃ¶sse der Chat-Box abgelegt.
function handleInputFocus() {
    if (isIOS()) {
        /** GrÃ¶sse von Chatbox wegen Tastatur anpassen, damit diese ganz angezeigt wird auf iPhone. */
        if(!abusiness_chatbot_chat_height) abusiness_chatbot_chat_height = $(".abusiness-chatbot-chat").height();
        var iResize = setInterval(function() {
            var height = calculateVisibleHeight();
            if(height < abusiness_chatbot_chat_height) {
                $(".abusiness-chatbot-chat").height(height+1);
                window.scrollTo({ top:0, left:0, behavior: "instant"})
                clearInterval(iResize);
            }
        }, 50);
        
    }
}
function handleInputBlur() {
    if (isIOS()) {
        /** GrÃ¶sse von Chatbox wieder maximieren, damit diese ganz angezeigt wird auf iPhone. */
        $(".abusiness-chatbot-chat").height(abusiness_chatbot_chat_height);
        
        /** Layer wieder einblenden, damit die Tastatur korrekt Ã¶ffnet auf dem iPhone. */
        setTimeout(function() {
            $(".abusiness-chatbot-message-box-layer").show();
        }, 300);
    }
}


/** Auf oder Zugeklappt? */
var blnOpen = 1; //Init
if(!getCookie("abuchat_blnopen")) {
    setCookie("abuchat_blnopen", 1, 1);
} else {
    blnOpen = getCookie("abuchat_blnopen");
}

var $messages, d, h, m, i;

var iExec = setInterval(function() {
    if(blnJSLoaded == true && blnCSSLoaded == true) {
        clearInterval(iExec);
        
        insertHTMLAndCallback(atobEx('DQogICAgPGRpdiBjbGFzcz0iYWJ1Y2hhdCI+DQogICAgICAgIDxkaXYgY2xhc3M9ImFidXNpbmVzcy1jaGF0Ym90LWNoYXQiPg0KICAgICAgICAgIDxkaXYgY2xhc3M9ImFidXNpbmVzcy1jaGF0Ym90LWNoYXQtdGl0bGUiPg0KICAgICAgICAgICAgPGRpdiBjbGFzcz0iaDFjaGF0Ij5WaXJ0dWVsbGVyIEFzc2lzdGVudDwvZGl2Pg0KICAgICAgICAgICAgPGRpdiBjbGFzcz0iYWJ1c2luZXNzLWNoYXRib3QtY2xvc2UtYnV0dG9uIj7igJQ8L2Rpdj4NCiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImgyY2hhdCI+QW50d29ydGV0IG5vcm1hbGVyd2Vpc2UgaW5uZXJoYWxiIHZvbiA1IFNla3VuZGVuLjwvZGl2Pg0KICAgICAgICAgICAgPGZpZ3VyZSBjbGFzcz0iYWJ1c2luZXNzLWNoYXRib3QtYXZhdGFyIj4NCiAgICAgICAgICAgICAgPGltZyBzcmM9Imh0dHBzOi8vbGFuZ21laWVyLmFidXNpbmVzcy5uZXQvZ2V0ZmlsZS9jZWRiMjEwNS03NmIxLTExZWUtOWRkYS00MjAxMGE3MmMwMDY/ZG93bmxvYWQiIC8+DQogICAgICAgICAgICA8L2ZpZ3VyZT4NCiAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICA8ZGl2IGNsYXNzPSJhYnVzaW5lc3MtY2hhdGJvdC1tZXNzYWdlcyI+DQogICAgICAgICAgICA8ZGl2IGNsYXNzPSJhYnVzaW5lc3MtY2hhdGJvdC1tZXNzYWdlcy1jb250ZW50Ij48L2Rpdj4NCiAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICA8ZGl2IGNsYXNzPSJhYnVzaW5lc3MtY2hhdGJvdC1tZXNzYWdlLWJveCI+DQogICAgICAgICAgICA8ZGl2IGNsYXNzPSJhYnVzaW5lc3MtY2hhdGJvdC1tZXNzYWdlLWJveC1sYXllciI+PC9kaXY+DQogICAgICAgICAgICA8dGV4dGFyZWEgdHlwZT0idGV4dCIgY2xhc3M9ImFidXNpbmVzcy1jaGF0Ym90LW1lc3NhZ2UtaW5wdXQiIHBsYWNlaG9sZGVyPSJXYXMgYmVzY2jDpGZ0aWd0IFNpZT8iPjwvdGV4dGFyZWE+DQogICAgICAgICAgICA8YnV0dG9uIHR5cGU9InN1Ym1pdCIgY2xhc3M9ImFidXNpbmVzcy1jaGF0Ym90LW1lc3NhZ2Utc3VibWl0Ij4NCiAgICAgICAgICAgICAgIDxpbWcgc3JjPSJodHRwczovL2ZpbGVzLmFidXNpbmVzcy5uZXQvY2hhdGJvdC92MS9pbWFnZXMvc2VuZC5zdmciPjwvaW1nPg0KICAgICAgICAgICAgPC9idXR0b24+DQogICAgICAgICAgPC9kaXY+DQogICAgICAgICAgPGRpdiBjbGFzcz0iYWJ1c2luZXNzLWNoYXRib3QtbWVzc2FnZS1wb3dlcmVkYnkiPg0KICAgICAgICAgICAgPGEgdGFyZ2V0PSJfYmxhbmsiIGhyZWY9Imh0dHBzOi8vd3d3LmFidXNpbmVzcy5vbmUiPkVyc3RlbGx0IG1pdCBhQnVzaW5lc3MgU3VpdGU8L2E+DQogICAgICAgICAgPC9kaXY+DQogICAgICAgIA0KICAgICAgICA8L2Rpdj4NCiAgICAgICAgDQogICAgICAgIDxkaXYgY2xhc3M9ImFidXNpbmVzcy1jaGF0Ym90LWljb24iDQogICAgICAgICAgICAgdGl0bGU9Ikhhc3QgRHUgRnJhZ2VuPyBGcmFnIG1pY2ggZXR3YXMhIj4NCiAgICAgICAgICAgIA0KICAgICAgICA8L2Rpdj4NCiAgICAgICAgDQogICAgICAgIDxkaXYgY2xhc3M9ImJnIj48L2Rpdj4NCiAgICA8L2Rpdj4NCiAgICA='), function() {
            // Hier kannst du deinen weiteren Code eingeben, der ausgefÃ¼hrt wird, sobald das HTML geladen ist.
            
                            $(".abusiness-chatbot-icon").css("background-image", "url('https://langmeier.abusiness.net/getfile/ced8bd7e-76b1-11ee-9dda-42010a72c006?download')");
                            $(".abusiness-chatbot-icon").show();
            
            /** CI-Color definieren */
            $("body").get(0).style.setProperty("--abuchatcicolor", "#0077bf");
            
            /** Damit auf Mobile die grÃ¶sse angepasst wird, braucht es diese Event-Handler. */
            $(".abusiness-chatbot-message-input").focus(handleInputFocus); //Textfeld selektiert
            $(".abusiness-chatbot-message-input").blur(handleInputBlur); //Textfeld verlassen
            
            /** Auf MobilegerÃ¤ten muss die Tastatatur beim absenden der Nachricht offen bleiben! */
            const btn = document.querySelector(".abusiness-chatbot-message-submit");
            if(btn) {
              btn.addEventListener("touchend", (e)=>{
                e.preventDefault();
                //functions for the Button need to be called here
                insertMessage();
              });
            }
            
            if(isIOS()) {
                /** Textfeld deaktivieren, indem ein darÃ¼berliegender DIV den Klick abfÃ¤ngt,
                    damit es aktiviert werden und fokussiert werden kann.
                    Nur so funktioniert der scroll korrekt.
                 */
                $(".abusiness-chatbot-message-input").css("font-size", "16px");
                $(".abusiness-chatbot-message-box-layer").show();
                $(".abusiness-chatbot-message-box-layer").click(function() {
                    $(this).hide();
                    $(".abusiness-chatbot-message-input").focus();
                    setTimeout(function() {
                        updateScrollbar();
                    },150);
                    setTimeout(function() {
                        updateScrollbar();
                    },300);
                    setTimeout(function() {
                        updateScrollbar();
                    },500);
                    setTimeout(function() {
                        updateScrollbar();
                    },650);
                });
            }
            
            /** Bei MobilgerÃ¤ten oder bei kleiner BildgrÃ¶sse, den Chat erstmal ausblenden. */
            var ismobile = mobilecheck();
            if(ismobile || $( window ).width() < 601 || blnOpen == 0) {
                $(".abusiness-chatbot-chat").hide();
                $(".abusiness-chatbot-icon").removeClass("abusiness-chatbot-icon-chatisopen");
            
            }
            
            /* Verhindern, dass der Hintergrund beim Wischen scrollt: */
            $(".abusiness-chatbot-chat").css("touch-action", "none");
            
            /** ******************************************/
            /** Jetzt wird der eigentliche Chat geladen. */
            /** ******************************************/
        
            /** Chat-Scrollbar fÃ¼r malihu-custom-scrollbar-plugin laden: */
            $messages = $('.abusiness-chatbot-messages-content');
            i = 0;
            
            $messages.mCustomScrollbar();
            setTimeout(function() {
            /** Welcome-Message laden */
            var url = "https://langmeier.abusiness.net/api/v1/gpt/welcome?chatbotuuid=" + chatbotuuid + "&lang=de&sessionguid=" + sessionguid + "";
            
            /** JSONP Request */
            $.ajax({
              url: url,
              dataType: 'jsonp',
              jsonp: 'callback',
              success: function(response) {
                var decodedResponse = atobEx(response);
                
                
                // Trennen der einzelnen Ergebnisse
                var results = decodedResponse.split('|||');
                if(results[1]) {
                    displayMessage(results[0]);
                    
                    var history = JSON.parse(results[1]);
                    
                    // Dekodieren und speichern der Ergebnisse
                    history.forEach(function (item) {
                        if(item.role == "assistant") {
                            displayMessageSplit(item.content, true);
                            
                        } else if(item.role == "user") {
                            $('<div class="abusiness-chatbot-message abusiness-chatbot-message-personal">' + item.content + '</div>').appendTo($('.mCSB_container')).addClass('abusiness-chatbot-new');
                            setDate();
                        }
                    });
                    updateScrollbar();
                    
                } else {
                    //Dem Kunden anzeigen:
                    displayMessage(decodedResponse);
                }
                
              }
            });
            
            }, 100);
            
            $(".abusiness-chatbot-message-box, .abusiness-chatbot-message-poweredby").click(function() {
                $(".abusiness-chatbot-message-input").focus();
            });
            $(".abusiness-chatbot-message-input").focus();
            
                        
            $(".abusiness-chatbot-close-button, .abusiness-chatbot-chat-title").click(function() {
                $(".abusiness-chatbot-chat").fadeOut(300);
                $(".abusiness-chatbot-icon").removeClass("abusiness-chatbot-icon-chatisopen");
                
                /** Eigentliche Webseite wieder freigeben. */
                if(ismobile) $("body").css("position", "inherit");
                setCookie("abuchat_blnopen", 0, 1);
            });
            $(".abusiness-chatbot-icon").click(function() {
                if($(".abusiness-chatbot-chat").css("display") == "none") {
                    $(".abusiness-chatbot-chat").fadeIn(300);
                    $(".abusiness-chatbot-icon").addClass("abusiness-chatbot-icon-chatisopen");
                    updateScrollbar();
                    
                    /** Eigentliche Webseite einfrieren, damit der Chat korrekt scrollt. */
                    if(ismobile) $("body").css("position", "fixed");
                    setCookie("abuchat_blnopen", 1, 1);
                    
                } else {
                    $(".abusiness-chatbot-chat").fadeOut(300);
                    $(".abusiness-chatbot-icon").removeClass("abusiness-chatbot-icon-chatisopen");
                    
                    /** Eigentliche Webseite wieder freigeben. */
                    if(ismobile) $("body").css("position", "inherit");
                    setCookie("abuchat_blnopen", 0, 1);
                }
            });
            
            $(".abusiness-chatbot-message-input").on("input", function() {
                checkChatFieldSize();
            });
            $(".abusiness-chatbot-message-submit").click(function() {
                $(".abusiness-chatbot-message-input").height("25px");
            }); 
            
            $('.abusiness-chatbot-message-submit').click(function() {
              insertMessage();
            });
            
            $(window).on('keydown', function(e) {
              if (e.which == 13) {
                insertMessage();
                return false;
              }
            });
        });
    }
}, 200);

}

/** Um sicherzustellen dass alle Bibliotheken geladen sind,
    ein wenig Delay geben.
*/
setTimeout(function() {
    abuchatbot();
}, 100);

